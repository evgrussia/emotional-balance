---
title: "Бизнес-процессы — Emotional Balance MVP"
created_by: "Business-Analyst Agent"
created_at: "2026-02-04"
version: "1.0"
status: "draft"
related_to:
  - "docs/discovery/prd.md"
  - "docs/discovery/user-stories.md"
  - "docs/discovery/vision.md"
---

# Бизнес-процессы: Emotional Balance (Нейро-Психолог 24/7)

## Содержание

- [1. Введение и методология](#1-введение-и-методология)
- [2. AS-IS процессы](#2-as-is-процессы)
- [3. TO-BE процессы](#3-to-be-процессы)
- [4. Gap Analysis](#4-gap-analysis)
- [5. Automation Opportunities](#5-automation-opportunities)
- [6. Метрики процессов (KPI)](#6-метрики-процессов-kpi)
- [7. Swimlane Summary](#7-swimlane-summary)

---

## 1. Введение и методология

### 1.1 Цель документа

Документ описывает бизнес-процессы платформы Emotional Balance на двух уровнях:

- **AS-IS** — текущее состояние: как пользователи решают проблему психологической помощи сегодня, без платформы.
- **TO-BE** — целевое состояние: как процессы будут организованы внутри платформы после запуска MVP.

### 1.2 Методология

Для описания процессов используется текстовая BPMN-подобная нотация:

| Элемент | Обозначение | Описание |
|---------|-------------|----------|
| Начало процесса | `[START]` | Событие, инициирующее процесс |
| Конец процесса | `[END]` | Завершающее событие |
| Действие | `>> Шаг N:` | Действие участника |
| Развилка (XOR) | `<DECISION>` | Эксклюзивный выбор (один из путей) |
| Развилка (AND) | `<PARALLEL>` | Параллельные потоки |
| Ожидание | `<WAIT>` | Ожидание внешнего события |
| Ошибка/исключение | `<ERROR>` | Альтернативный поток при ошибке |
| Системное действие | `[SYSTEM]` | Автоматическое действие системы |
| Пользователь | `[USER]` | Действие пользователя |
| Психолог | `[PSYCHOLOGIST]` | Действие психолога-специалиста |
| HR-администратор | `[HR-ADMIN]` | Действие корпоративного администратора |
| Администратор | `[ADMIN]` | Действие администратора платформы |

### 1.3 Акторы системы

| ID | Актор | Описание | Персоны (PRD) |
|----|-------|----------|---------------|
| A1 | Пользователь (B2C) | Конечный пользователь платформы | Аня, Дмитрий, Олег |
| A2 | HR-администратор | Корпоративный клиент, управляющий группой сотрудников | Марина |
| A3 | Психолог | Верифицированный специалист на маркетплейсе | Елена |
| A4 | Администратор платформы | Оператор и технический администратор | Сергей |
| A5 | ИИ-система | Автоматизированный агент на базе GigaChat/YandexGPT | — |
| A6 | Платёжная система | YooKassa — обработка платежей | — |
| A7 | Wearable-устройство | Apple Watch / Mi Band — источник биометрии | — |
| A8 | Telegram Bot | Канал уведомлений и точка входа | — |

---

## 2. AS-IS процессы

### AS-IS-001: Получение психологической помощи (текущее состояние)

**Описание:** Как человек с тревожностью, стрессом или депрессией получает психологическую помощь сегодня, без платформы Emotional Balance.

**Участники:** Человек, Психолог (частнопрактикующий или в клинике), Онлайн-агрегатор (Zigmund/YouTalk)

#### Основной поток

```
[START] Человек осознаёт проблему (тревога, бессонница, паника)

>> Шаг 1: [USER] Пытается справиться самостоятельно
   - Читает статьи в интернете
   - Пробует советы из YouTube / соцсетей
   - Время: дни — недели — месяцы

<DECISION> Самопомощь помогла?
   ├─ ДА → [END] Проблема ослабла (временно)
   └─ НЕТ → Шаг 2

>> Шаг 2: [USER] Решается обратиться к специалисту
   - Преодолевает стигму ("я не псих")
   - Время: недели — месяцы

>> Шаг 3: [USER] Ищет психолога
   - Спрашивает знакомых / ищет в интернете / на агрегаторе
   - Сравнивает цены (3 000 — 7 000 руб/сессия)
   - Читает отзывы
   - Время: 1-7 дней

<DECISION> Подходящий психолог найден?
   ├─ ДА → Шаг 4
   ├─ НЕТ (финансовый барьер) → [END] Отказ от помощи
   └─ НЕТ (географический барьер) → [END] Нет специалистов в регионе

>> Шаг 4: [USER] Записывается на приём
   - Звонит / пишет / заполняет форму
   - Ожидание свободного слота: 3-14 дней
   - Время: 3-14 дней

>> Шаг 5: [USER] Посещает первую сессию
   - 50 минут
   - Рассказывает всё с нуля
   - Получает первые рекомендации

<DECISION> Специалист подходит?
   ├─ ДА → Шаг 6
   └─ НЕТ → возврат к Шагу 3 (повторный поиск)

>> Шаг 6: [USER] Продолжает терапию (регулярные сессии)
   - 1 сессия/неделю, 8-20 сессий (2-5 мес.)
   - Суммарная стоимость: 24 000 — 140 000 руб
   - Между сессиями — без поддержки

[END] Частичное или полное улучшение (через 2-5 мес.)
```

#### Боли и барьеры

| # | Боль | Описание | Влияние |
|---|------|----------|---------|
| P1 | Финансовый барьер | 3 000-7 000 руб/сессия, курс 24 000-140 000 руб | 70%+ населения не могут позволить |
| P2 | Временной барьер | Ожидание записи 3-14 дней | Помощь недоступна в момент кризиса |
| P3 | Географический барьер | 5 психологов на 100 000 в регионах | Физически нет специалистов |
| P4 | Стигматизация | Страх осуждения, "я не псих" | 60% не обращаются вообще |
| P5 | Информационный барьер | Не знают с чего начать, как выбрать | Высокий порог входа |
| P6 | Отсутствие поддержки 24/7 | Паника ночью — помощь утром | Критический разрыв в помощи |
| P7 | Нет преемственности | Каждую сессию начинают "с нуля" | Потеря контекста между визитами |
| P8 | Нет самопомощи между сессиями | Между визитами человек один | Терапевтический эффект снижается |

---

### AS-IS-002: Корпоративный wellness (текущее состояние)

**Описание:** Как HR-отделы организуют wellness-программы для сотрудников сегодня.

**Участники:** HR-директор, Сотрудники, Внешний провайдер (тренинговая компания / EAP)

#### Основной поток

```
[START] HR осознаёт проблему выгорания / текучести

>> Шаг 1: [HR-ADMIN] Исследует рынок wellness-решений
   - EAP (Employee Assistance Program): 500-1500 руб/сотр/мес
   - Тренинги: 50 000 — 200 000 руб за мероприятие
   - Корпоративный психолог: 80 000 — 150 000 руб/мес (1 ставка)
   - Время: 2-4 недели

>> Шаг 2: [HR-ADMIN] Согласовывает бюджет с руководством
   - Обоснование ROI (снижение текучести, больничных)
   - Время: 2-8 недель

<DECISION> Бюджет одобрен?
   ├─ ДА → Шаг 3
   └─ НЕТ → [END] Wellness-программа не запущена

>> Шаг 3: [HR-ADMIN] Заключает договор с провайдером
   - Выбор провайдера, согласование условий
   - Время: 2-4 недели

>> Шаг 4: [HR-ADMIN] Информирует сотрудников
   - Рассылка, презентация, корпоративный портал
   - Стигма: сотрудники боятся, что данные увидит HR

>> Шаг 5: Сотрудники используют программу
   - Типичная вовлечённость EAP: 3-8%
   - Основная причина: недоверие к конфиденциальности

>> Шаг 6: [HR-ADMIN] Получает отчёт (раз в квартал)
   - Агрегированные данные (если повезёт)
   - Сложно измерить ROI

[END] Программа работает с низкой эффективностью
```

#### Проблемы текущего подхода

| # | Проблема | Описание |
|---|----------|----------|
| C1 | Низкая вовлечённость | 3-8% сотрудников используют EAP |
| C2 | Стигма конфиденциальности | Сотрудники боятся, что данные попадут к HR |
| C3 | Отсутствие аналитики | HR не видит реальную картину стресса |
| C4 | Высокая стоимость | EAP: 500-1500 руб/сотр/мес, тренинги: от 50 000 руб |
| C5 | Точечные интервенции | Тренинг раз в квартал — не системный подход |
| C6 | Нет персонализации | Одинаковая программа для всех сотрудников |
| C7 | Долгий запуск | 2-4 месяца от решения до старта |

---

## 3. TO-BE процессы

### BP-001: Онбординг пользователя

**Связь с FR:** FR-001 (Онбординг и регистрация)
**Связь с US:** US-001, US-002, US-003, US-004

#### Участники (Actors)

| Актор | Роль в процессе |
|-------|-----------------|
| Пользователь (A1) | Регистрируется и настраивает профиль |
| Telegram Bot (A8) | Точка входа, OAuth-провайдер |
| ИИ-система (A5) | Формирует персональный профиль на основе опросника |

#### Предусловия (Preconditions)

- Пользователь имеет аккаунт в Telegram
- Telegram WebApp доступен на устройстве пользователя
- Серверная часть платформы функционирует

#### Основной поток

```
[START] Пользователь переходит по ссылке / открывает бот

>> Шаг 1: [USER] Открывает WebApp в Telegram
   - Нажимает кнопку "Начать" в боте или переходит по deep link

>> Шаг 2: [SYSTEM] Telegram OAuth авторизация
   - Автоматическое получение данных пользователя (имя, аватар, Telegram ID)
   - Создание аккаунта в системе

<DECISION> Пользователь новый?
   ├─ ДА → Шаг 3
   └─ НЕТ → [END] Перенаправление на главный экран (авторизация)

>> Шаг 3: [SYSTEM] Показ экрана Disclaimer
   - Текст: "Это НЕ замена профессиональной психологической или медицинской помощи"
   - Контакт горячей линии: 8-800-2000-122
   - Чекбокс согласия на обработку ПДн (ФЗ-152)

>> Шаг 4: [USER] Подтверждает Disclaimer
   - Отмечает чекбокс ФЗ-152
   - Нажимает "Принимаю и продолжаю"

<DECISION> Пользователь принял Disclaimer?
   ├─ ДА → Шаг 5
   └─ НЕТ → [END] Регистрация не завершена, при следующем входе — повторный показ

>> Шаг 5: [SYSTEM] Показ начального опросника (4 шага)
   - Шаг 5.1: Оценка текущего настроения (шкала 1-10, визуальный слайдер)
   - Шаг 5.2: Основные проблемы (мультивыбор: тревожность, депрессия, стресс, бессонница, выгорание, отношения, другое)
   - Шаг 5.3: Цели использования (мультивыбор: справиться с тревогой, улучшить сон, научиться расслабляться, понять себя, другое)
   - Шаг 5.4: Триггеры (мультивыбор: работа, отношения, здоровье, финансы, другое)

<DECISION> Пользователь заполнил опросник?
   ├─ ДА (полное заполнение) → Шаг 6
   ├─ ЧАСТИЧНО (прервал) → [SYSTEM] Сохранение прогресса, при следующем входе — предложение продолжить
   └─ НЕТ (нажал "Пропустить") → [SYSTEM] Создание дефолтного профиля → Шаг 7

>> Шаг 6: [SYSTEM] Формирование персонального профиля
   - ИИ-система анализирует ответы опросника
   - Определяются: основная проблематика, рекомендуемые упражнения, стиль общения ИИ

>> Шаг 7: [SYSTEM] Показ экрана выбора тарифа
   - Free: базовый доступ (описание ограничений)
   - Standard (990 руб/мес): полный чат, дневник, упражнения
   - Premium (2990 руб/мес): голос, медитации, wearables

>> Шаг 8: [USER] Выбирает тарифный план

<DECISION> Какой тариф выбран?
   ├─ Free → [SYSTEM] Активация Free-тарифа → Шаг 9
   ├─ Standard → [SYSTEM] Редирект на YooKassa (trial 7 дней) → BP-010
   └─ Premium → [SYSTEM] Редирект на YooKassa (trial 7 дней) → BP-010

>> Шаг 9: [SYSTEM] Перенаправление на главный экран
   - Персонализированные рекомендации на основе профиля
   - Подсказки по первым шагам ("Попробуйте чат", "Заполните дневник")

[END] Онбординг завершён, пользователь на главном экране
```

#### Альтернативные потоки

| ID | Условие | Поток |
|----|---------|-------|
| BP-001-A1 | Telegram OAuth недоступен | Показ сообщения "Ошибка авторизации", кнопка "Повторить" |
| BP-001-A2 | Пользователь пришёл по реферальной ссылке | После Шага 2 — привязка реферера, после Шага 8 — автоматический Premium trial 7 дней |
| BP-001-A3 | Пользователь пришёл по B2B-ссылке | После Шага 2 — привязка к корпоративной группе, тариф определяется B2B-контрактом |

#### Постусловия (Postconditions)

- Аккаунт пользователя создан в системе
- Персональный профиль сформирован (или дефолтный)
- Тарифный план выбран и активирован
- Согласие на обработку ПДн зафиксировано
- Аудит-лог: запись о регистрации

---

### BP-002: AI-чат сессия

**Связь с FR:** FR-002 (ИИ-чат 24/7), FR-006 (Детектор кризисов)
**Связь с US:** US-005, US-006, US-007

#### Участники (Actors)

| Актор | Роль в процессе |
|-------|-----------------|
| Пользователь (A1) | Инициирует и ведёт диалог |
| ИИ-система (A5) | Ведёт терапевтический диалог с использованием КПТ |
| Детектор кризисов (A5) | Анализирует каждое сообщение на кризисные маркеры |

#### Предусловия (Preconditions)

- Пользователь авторизован в системе
- Профиль пользователя существует (минимум дефолтный)
- LLM API (GigaChat / YandexGPT) доступен
- RAG-база КПТ-протоколов загружена

#### Основной поток

```
[START] Пользователь нажимает "Чат с психологом" на главном экране

>> Шаг 1: [SYSTEM] Загрузка контекста сессии
   - Загрузка профиля пользователя
   - Загрузка истории предыдущих сессий (последние 5)
   - Загрузка данных дневника (последние 7 дней)
   - Загрузка прогресса КПТ-упражнений

<DECISION> Есть незавершённая предыдущая сессия?
   ├─ ДА → [SYSTEM] Предложение: "Продолжить" / "Начать новую сессию"
   └─ НЕТ → Шаг 2

>> Шаг 2: [SYSTEM] Инициализация чат-интерфейса
   - ИИ отправляет приветственное сообщение с учётом контекста
   - Пример: "Привет, [Имя]. Как вы себя чувствуете сегодня?"
   - Если есть данные дневника: "Вижу, что вчера уровень тревоги был 7/10. Расскажите, как сегодня?"

>> Шаг 3: [USER] Пишет сообщение

>> Шаг 4: [SYSTEM] Параллельная обработка сообщения
   <PARALLEL>
   ├─ Поток A: Детектор кризисов анализирует сообщение (→ BP-006)
   └─ Поток B: LLM формирует ответ через RAG + КПТ-протоколы
   </PARALLEL>

<DECISION> Детектор кризисов: какой уровень?
   ├─ CRITICAL → Немедленная эскалация → BP-006
   ├─ HIGH → Мягкая эскалация (предложение специалиста) + продолжение диалога
   ├─ MODERATE → Повышенная эмпатия, периодическое предложение специалиста
   └─ LOW → Стандартный КПТ-диалог → Шаг 5

>> Шаг 5: [SYSTEM] ИИ формирует ответ с КПТ-техникой
   - Когнитивное реструктурирование (выявление автоматических мыслей)
   - Поведенческая активация (планирование действий)
   - Валидация эмоций (эмпатия и нормализация)
   - Ответ выводится в streaming-режиме (посимвольно)

>> Шаг 6: [USER] Читает ответ, пишет следующее сообщение

<DECISION> Пользователь продолжает диалог?
   ├─ ДА → возврат к Шагу 3 (цикл диалога)
   └─ НЕТ (нажал "Завершить" / 30 мин неактивности) → Шаг 7

>> Шаг 7: [SYSTEM] Проверка тарифных лимитов
   <DECISION> Лимит сообщений исчерпан? (Free: 5 сообщений/день)
      ├─ ДА → [SYSTEM] Уведомление о лимите + предложение апгрейда → Шаг 8
      └─ НЕТ → возврат к Шагу 3

>> Шаг 8: [SYSTEM] Завершение сессии
   - Генерация саммари сессии (ключевые темы, выявленные мысли, рекомендации)
   - Предложение: "Хотите записать текущее состояние в дневник эмоций?"
   - Предложение оценки сессии (1-5 звёзд)

>> Шаг 9: [SYSTEM] Сохранение данных
   - Сохранение истории чата
   - Обновление профиля пользователя (новые инсайты)
   - Запись в дневник (если пользователь согласился)
   - Аудит-лог: сессия завершена, длительность, количество сообщений

[END] Сессия завершена, саммари доступно в истории
```

#### Альтернативные потоки

| ID | Условие | Поток |
|----|---------|-------|
| BP-002-A1 | LLM API недоступен | Graceful degradation: "Сервис временно недоступен", предложение дыхательной практики / дневника |
| BP-002-A2 | Вопрос вне компетенции ИИ | ИИ: "Этот вопрос выходит за мои возможности. Рекомендую специалиста" + ссылка на маркетплейс |
| BP-002-A3 | ИИ рекомендует упражнение | Встроенная ссылка на КПТ-упражнение (BP-005) прямо из чата |

#### Постусловия (Postconditions)

- История сессии сохранена
- Саммари сессии сгенерировано
- Профиль пользователя обновлён новыми инсайтами
- Оценка сессии зафиксирована (если дана)
- Все сообщения проверены детектором кризисов

---

### BP-003: Голосовая сессия

**Связь с FR:** FR-003 (Голосовые сессии)
**Связь с US:** US-008, US-009

#### Участники (Actors)

| Актор | Роль в процессе |
|-------|-----------------|
| Пользователь (A1) | Говорит с ИИ голосом |
| ИИ-система (A5) | STT (распознавание) + LLM (ответ) + TTS (озвучка) |
| Детектор кризисов (A5) | Анализирует транскрибированный текст |

#### Предусловия (Preconditions)

- Пользователь на тарифе Standard или Premium
- Микрофон доступен на устройстве
- Self-hosted STT/TTS engine работает
- Лимит голосовых сессий не исчерпан (Standard: 30 мин/день)

#### Основной поток

```
[START] Пользователь нажимает "Голосовая сессия" в чате

>> Шаг 1: [SYSTEM] Проверка тарифа и лимитов

<DECISION> Тариф позволяет голосовые сессии?
   ├─ Free → [SYSTEM] "Голосовые сессии доступны на Standard/Premium" → [END]
   ├─ Standard (лимит не исчерпан) → Шаг 2
   ├─ Standard (лимит исчерпан) → [SYSTEM] "Лимит на сегодня исчерпан" + предложение Premium → [END]
   └─ Premium → Шаг 2

>> Шаг 2: [SYSTEM] Активация микрофона
   - Запрос разрешения на микрофон (если первый раз)
   - Отображение индикатора "Запись..."

>> Шаг 3: [USER] Произносит сообщение

>> Шаг 4: [SYSTEM] STT — преобразование речи в текст
   - Self-hosted STT engine обрабатывает аудио
   - Шумоподавление на стороне клиента (P1)
   - Целевая latency: < 3 сек

<DECISION> Речь распознана успешно?
   ├─ ДА → Шаг 5
   └─ НЕТ → [SYSTEM] "Не удалось распознать. Попробуйте снова или переключитесь на текст."

>> Шаг 5: [SYSTEM] Отображение транскрипции + индикатор "ИИ думает..."
   - Пользователь видит текстовую расшифровку своих слов
   - Параллельно: детектор кризисов анализирует транскрипцию

>> Шаг 6: [SYSTEM] LLM формирует ответ (аналогично BP-002, Шаг 5)

>> Шаг 7: [SYSTEM] TTS — озвучка ответа ИИ
   - Индикатор "ИИ говорит..."
   - Целевая latency TTS: < 2 сек
   - Голос по выбору (мужской/женский, P1)

>> Шаг 8: [USER] Слушает ответ

<DECISION> Пользователь хочет переключиться на текст?
   ├─ ДА → [SYSTEM] Деактивация микрофона, продолжение в текстовом режиме (BP-002)
   └─ НЕТ → <DECISION> Продолжить диалог?
              ├─ ДА → возврат к Шагу 3
              └─ НЕТ → Шаг 9

>> Шаг 9: [SYSTEM] Завершение голосовой сессии
   - Сохранение полной текстовой транскрипции
   - Генерация саммари (аналогично BP-002, Шаг 8)
   - Пометка "Голосовая сессия" в истории

[END] Голосовая сессия завершена, транскрипция сохранена
```

#### Альтернативные потоки

| ID | Условие | Поток |
|----|---------|-------|
| BP-003-A1 | STT engine перегружен | Предложение: "Голосовой сервис временно недоступен. Переключиться на текст?" |
| BP-003-A2 | Шумная обстановка (низкое качество распознавания) | Предложение переключиться на текст после 2 неудачных попыток |
| BP-003-A3 | Лимит Standard исчерпан во время сессии | Уведомление за 2 минуты до лимита + плавное завершение |

#### Постусловия (Postconditions)

- Транскрипция голосовой сессии сохранена
- Использованное время учтено в лимитах тарифа
- Все высказывания проверены детектором кризисов
- Аудит-лог: голосовая сессия, длительность, количество реплик

---

### BP-004: Дневник эмоций

**Связь с FR:** FR-004 (Дневник эмоций)
**Связь с US:** US-010, US-011, US-012, US-013

#### Участники (Actors)

| Актор | Роль в процессе |
|-------|-----------------|
| Пользователь (A1) | Записывает эмоциональное состояние |
| ИИ-система (A5) | Анализирует паттерны, генерирует инсайты |
| Telegram Bot (A8) | Отправляет push-напоминания |

#### Предусловия (Preconditions)

- Пользователь авторизован
- Лимит записей не исчерпан (Free: 1/день)

#### Основной поток

```
[START] Пользователь открывает "Дневник эмоций" → "Новая запись"
         ИЛИ Пользователь нажимает push-напоминание от бота

>> Шаг 1: [USER] Выбирает эмоцию из палитры
   - Радость, грусть, тревога, злость, спокойствие, страх, удивление, отвращение
   - Визуальные иконки с цветовой кодировкой

>> Шаг 2: [USER] Устанавливает интенсивность (1-10)
   - Визуальный слайдер с цветовым градиентом

>> Шаг 3: [USER] Пишет текстовую заметку (опционально)
   - Поле: "Что произошло? Опишите ситуацию."
   - Опциональные теги: работа, отношения, здоровье, финансы, семья, учёба

>> Шаг 4: [USER] Нажимает "Сохранить"

>> Шаг 5: [SYSTEM] Сохранение записи
   - Запись с timestamp, эмоцией, интенсивностью, заметкой, тегами
   - Если подключены wearables — привязка биометрии (HR, HRV) на момент записи

>> Шаг 6: [SYSTEM] ИИ-анализ (асинхронный, для Standard/Premium)
   - При накоплении >= 7 записей за 7 дней:
     - Выявление триггеров (корреляция эмоций с тегами и временем)
     - Определение паттернов (циклы, тренды)
     - Формирование рекомендаций (упражнения, практики)

>> Шаг 7: [SYSTEM] Обновление визуализации
   - Линейный график эмоций за неделю/месяц
   - Распределение эмоций (pie chart)
   - Средняя интенсивность по дням

<DECISION> Это еженедельная контрольная точка? (воскресенье)
   ├─ ДА → [SYSTEM] Генерация еженедельного отчёта с инсайтами (P1) → push-уведомление
   └─ НЕТ → [END]

[END] Запись сохранена, аналитика обновлена
```

#### Альтернативные потоки

| ID | Условие | Поток |
|----|---------|-------|
| BP-004-A1 | Лимит Free исчерпан (1 запись/день) | "Лимит записей на сегодня исчерпан" + предложение Standard |
| BP-004-A2 | Push-напоминание, но запись уже сделана | Push НЕ отправляется (проверка перед отправкой) |
| BP-004-A3 | Запись из SOS-протокола (BP-007) | Автоматическая запись с пометкой "SOS-сессия" |

#### Постусловия (Postconditions)

- Новая запись сохранена в дневнике
- Визуализация обновлена
- ИИ-инсайты обновлены (при достаточном количестве данных)
- Аудит-лог: запись в дневник, эмоция, интенсивность

---

### BP-005: КПТ-упражнение

**Связь с FR:** FR-005 (КПТ-упражнения)
**Связь с US:** US-014, US-015, US-016

#### Участники (Actors)

| Актор | Роль в процессе |
|-------|-----------------|
| Пользователь (A1) | Выполняет упражнение пошагово |
| ИИ-система (A5) | Подбирает упражнение, адаптирует под контекст |

#### Предусловия (Preconditions)

- Пользователь авторизован
- Лимит упражнений не исчерпан (Free: 1/день)

#### Основной поток

```
[START] Пользователь открывает "КПТ-упражнения"
         ИЛИ ИИ рекомендует упражнение из чата (BP-002)

>> Шаг 1: [SYSTEM] Отображение каталога упражнений
   - Категории: когнитивное реструктурирование, поведенческая активация, экспозиция, решение проблем, релаксация
   - Сверху: ИИ-рекомендация на основе профиля, дневника и чата
   - Для каждого: название, описание, длительность (5-15 мин), сложность

>> Шаг 2: [USER] Выбирает упражнение

<DECISION> Лимит Free исчерпан?
   ├─ ДА → [SYSTEM] "Лимит на сегодня исчерпан" + предложение апгрейда → [END]
   └─ НЕТ → Шаг 3

>> Шаг 3: [USER] Нажимает "Начать"

>> Шаг 4: [SYSTEM] Пошаговое выполнение упражнения
   Пример: "Дневник мыслей" (когнитивное реструктурирование)
   - Шаг 4.1: "Опишите ситуацию, которая вас беспокоит" → [USER] вводит текст
   - Шаг 4.2: "Какие автоматические мысли возникли?" → [USER] вводит текст
   - Шаг 4.3: "Какие эмоции вы испытали?" → [USER] выбирает эмоции + интенсивность
   - Шаг 4.4: "Доказательства ЗА эту мысль?" → [USER] вводит текст
   - Шаг 4.5: "Доказательства ПРОТИВ?" → [USER] вводит текст
   - Шаг 4.6: "Сформулируйте альтернативную мысль" → [USER] вводит текст
   - Шаг 4.7: "Как изменились эмоции?" → [USER] повторная оценка

<DECISION> Пользователь прервал упражнение?
   ├─ ДА → [SYSTEM] Сохранение прогресса, при возврате — предложение продолжить
   └─ НЕТ → Шаг 5

>> Шаг 5: [SYSTEM] Завершение и сводка
   - Сводка результатов: начальная мысль → альтернативная мысль, изменение интенсивности
   - Предложение: "Сохранить в дневник эмоций?"
   - Оценка полезности упражнения (P1)

>> Шаг 6: [SYSTEM] Обновление прогресса
   - Общее число выполненных упражнений
   - Статистика по категориям
   - Серия дней (streak)
   - Динамика эмоций до/после упражнений

[END] Упражнение завершено, прогресс обновлён
```

#### Альтернативные потоки

| ID | Условие | Поток |
|----|---------|-------|
| BP-005-A1 | Упражнение рекомендовано из чата | Прямой переход к Шагу 3 с контекстом из чата |
| BP-005-A2 | Пользователь не знает что выбрать | ИИ-система предлагает на основе последней записи в дневнике или чат-сессии |

#### Постусловия (Postconditions)

- Результат упражнения сохранён
- Прогресс пользователя обновлён
- Связь с записью дневника установлена (если пользователь согласился)
- Аудит-лог: упражнение, категория, изменение интенсивности

---

### BP-006: Детектор кризисов + SOS эскалация

**Связь с FR:** FR-006 (Детектор кризисных состояний), FR-014 (SOS-протоколы)
**Связь с US:** US-017

#### Участники (Actors)

| Актор | Роль в процессе |
|-------|-----------------|
| Пользователь (A1) | Автор сообщения (не осведомлён о детекции) |
| ИИ-система — Детектор (A5) | Классифицирует уровень риска |
| Дежурный оператор (A4) | Получает алерт при critical-уровне |

#### Предусловия (Preconditions)

- Детектор кризисов активен (всегда, на всех тарифах, нельзя отключить)
- База кризисных маркеров актуальна
- Дежурный оператор доступен (для critical-уровня)

#### Основной поток

```
[START] Пользователь отправляет сообщение в чат (BP-002 / BP-003)

>> Шаг 1: [SYSTEM] Детектор анализирует сообщение
   - Проверка на кризисные маркеры (суицидальные, самоповреждение, безнадёжность)
   - Контекстный анализ (история сообщений за сессию)
   - Консервативный порог: лучше false positive, чем false negative

>> Шаг 2: [SYSTEM] Классификация уровня риска

<DECISION> Уровень риска?

   ├─ LOW (норма) →
   │  [SYSTEM] Стандартный ответ ИИ
   │  [END] Диалог продолжается в обычном режиме

   ├─ MODERATE (повышенная тревога/подавленность) →
   │  >> Шаг 3M: [SYSTEM] ИИ продолжает диалог с повышенной эмпатией
   │  >> Шаг 4M: [SYSTEM] Периодическое предложение: "Хотите поговорить со специалистом?"
   │  >> Шаг 5M: [SYSTEM] В конце сессии — рекомендация записи к психологу (BP-008)
   │  >> Шаг 6M: [SYSTEM] Логирование: moderate risk detected
   │  [END]

   ├─ HIGH (выраженная безнадёжность/отчаяние) →
   │  >> Шаг 3H: [SYSTEM] ИИ мягко переключает тему:
   │     "Я слышу, что вам сейчас очень тяжело. Вы не одиноки."
   │  >> Шаг 4H: [SYSTEM] Отображение:
   │     - Предложение: "Хотите поговорить с живым специалистом?"
   │     - Контакты экстренной помощи: 8-800-2000-122
   │     - Кнопка записи через маркетплейс (BP-008)
   │  >> Шаг 5H: [SYSTEM] Логирование: high risk detected
   │  [END]

   └─ CRITICAL (суицидальные маркеры) →
      >> Шаг 3C: [SYSTEM] НЕМЕДЛЕННОЕ действие:
         - Отображение: "Я вижу, что вам сейчас очень тяжело. Вы не одиноки."
         - Кнопка: "Позвонить на горячую линию: 8-800-2000-122" (прямой звонок)
         - Кнопка: "Связаться со специалистом прямо сейчас"
      >> Шаг 4C: [SYSTEM] Оповещение дежурного оператора
         - Telegram-алерт дежурному с контекстом (анонимизированный ID)
      >> Шаг 5C: [SYSTEM] Логирование: critical risk detected (audit log, обязательно)
      <DECISION> Пользователь нажал "Всё нормально"?
         ├─ ДА → [SYSTEM] Принять, НО НЕ отключить детектор, логировать как "declined escalation"
         └─ НЕТ → [SYSTEM] Продолжить показ контактов помощи
      [END]
```

#### Альтернативные потоки

| ID | Условие | Поток |
|----|---------|-------|
| BP-006-A1 | False positive — пользователь говорит в переносном смысле | ИИ принимает ответ, но детектор остаётся активным, логирование "declined escalation" |
| BP-006-A2 | Множественные срабатывания moderate за сессию | Автоповышение до high-уровня |

#### Постусловия (Postconditions)

- Уровень риска классифицирован и залогирован
- При critical/high — пользователю показаны контакты помощи
- При critical — дежурный оператор оповещён
- Детектор остаётся активным вне зависимости от ответа пользователя
- Аудит-лог: уровень, маркеры, реакция пользователя

---

### BP-007: SOS-протокол

**Связь с FR:** FR-014 (SOS-протоколы быстрой помощи)
**Связь с US:** US-038, US-039

#### Участники (Actors)

| Актор | Роль в процессе |
|-------|-----------------|
| Пользователь (A1) | Инициирует SOS, выполняет протокол |
| ИИ-система (A5) | Ведёт через протокол, TTS-озвучка |
| Детектор кризисов (A5) | Мониторит состояние |

#### Предусловия (Preconditions)

- SOS-кнопка доступна на всех экранах и на всех тарифах (включая Free)
- TTS engine доступен (при отсутствии — только текст + визуал)

#### Основной поток

```
[START] Пользователь нажимает SOS-кнопку (1 тап, видна на любом экране)

>> Шаг 1: [SYSTEM] Экран оценки состояния "до"
   - "Оцените своё состояние прямо сейчас (1-10)"
   - Быстрый ввод: слайдер

>> Шаг 2: [USER] Оценивает состояние

>> Шаг 3: [SYSTEM] Экран выбора ситуации
   - Паника / Паническая атака
   - Сильная тревога
   - Бессонница
   - Вспышка гнева
   - "Не могу дышать"
   - "Не могу остановить мысли"

>> Шаг 4: [USER] Выбирает ситуацию

>> Шаг 5: [SYSTEM] Запуск пошагового протокола (зависит от ситуации)

   Пример: "Паника / Паническая атака"
   - Шаг 5.1: Дыхание 4-7-8
     "Положите руку на грудь. Сейчас мы будем дышать вместе."
     Визуальная анимация (круг расширяется/сужается) + голос TTS + таймер
     Вдох 4 сек → Задержка 7 сек → Выдох 8 сек (3-5 циклов)
   - Шаг 5.2: Grounding 5-4-3-2-1
     "Назовите 5 предметов, которые видите"
     "4 звука, которые слышите"
     "3 вещи, к которым можете прикоснуться"
     "2 запаха"
     "1 вкус"
   - Шаг 5.3: Progressive muscle relaxation
     "Сожмите кулаки сильно на 5 секунд... Отпустите..."
     Поочерёдное напряжение/расслабление групп мышц

>> Шаг 6: [SYSTEM] Экран оценки состояния "после"
   - "Как вы себя чувствуете сейчас? (1-10)"

>> Шаг 7: [USER] Оценивает состояние повторно

>> Шаг 8: [SYSTEM] Результат и дальнейшие действия

<DECISION> Оценка "после" улучшилась?
   ├─ ДА (разница >= 2) → "Отлично, вы справились! Помните, вы сильнее, чем думаете."
   ├─ НЕЗНАЧИТЕЛЬНО (разница < 2) → "Если вам всё ещё тяжело, попробуйте ещё раз или поговорите с ИИ-психологом."
   └─ УХУДШЕНИЕ → "Я вижу, что вам всё ещё плохо. Давайте свяжемся со специалистом."
                    + Контакт горячей линии + маркетплейс

>> Шаг 9: [SYSTEM] Автоматическая запись в дневник
   - Эмоция: соответствующая выбранной ситуации
   - Интенсивность: оценка "до"
   - Заметка: "SOS-протокол: [ситуация], до: [X]/10, после: [Y]/10"
   - Тег: "SOS"

[END] SOS-протокол завершён, результаты записаны в дневник
```

#### Альтернативные потоки

| ID | Условие | Поток |
|----|---------|-------|
| BP-007-A1 | Детектор кризисов определил critical во время SOS | Мягкое переключение на кризисный протокол (BP-006, critical) |
| BP-007-A2 | Нет интернета (оффлайн) | Базовые протоколы (дыхание, grounding) из кэша, без TTS, синхронизация позже |
| BP-007-A3 | Пользователь прерывает протокол | Предложение: "Вернуться к протоколу?" + запись неполного результата |

#### Постусловия (Postconditions)

- Оценки до/после зафиксированы
- Запись автоматически создана в дневнике
- Геймификация: "укрепление корней" дерева здоровья
- Аудит-лог: SOS-протокол, ситуация, оценки до/после

---

### BP-008: Маркетплейс психологов

**Связь с FR:** FR-007 (Маркетплейс психологов)
**Связь с US:** US-018, US-019, US-020, US-021

#### Участники (Actors)

| Актор | Роль в процессе |
|-------|-----------------|
| Пользователь (A1) | Ищет, выбирает, оплачивает консультацию |
| Психолог (A3) | Управляет расписанием, проводит консультацию |
| Платёжная система (A6) | YooKassa — обработка оплаты |
| ИИ-система (A5) | Рекомендация психолога (P1) |

#### Предусловия (Preconditions)

- В каталоге есть верифицированные психологи (минимум 20 на старте)
- YooKassa интегрирована для приёма платежей
- Психолог настроил профиль и расписание

#### Основной поток

```
[START] Пользователь нажимает "Найти психолога" на главном экране

>> Шаг 1: [SYSTEM] Отображение каталога психологов
   - Карточки: фото, имя, специализация, стаж, рейтинг, цена, формат, ближайший слот
   - Фильтры: специализация, цена (от-до), рейтинг, онлайн/оффлайн, город
   - Сортировка: по рейтингу, по цене, по ближайшему слоту
   - ИИ-рекомендация (P1): "Рекомендуем на основе вашего профиля"

>> Шаг 2: [USER] Применяет фильтры и выбирает психолога

>> Шаг 3: [SYSTEM] Отображение профиля психолога
   - Полное описание, образование, сертификаты
   - Отзывы клиентов
   - Доступные слоты (календарь)

>> Шаг 4: [USER] Нажимает "Записаться"

>> Шаг 5: [SYSTEM] Отображение календаря со свободными слотами
   - Еженедельный вид с доступными временными окнами
   - Часовой пояс пользователя

>> Шаг 6: [USER] Выбирает дату и время

>> Шаг 7: [SYSTEM] Подтверждение и перенаправление на оплату
   - Сумма: цена сессии психолога
   - Скидка по тарифу: Standard -5%, Premium -10%
   - Перенаправление на YooKassa

>> Шаг 8: [A6 — YooKassa] Обработка платежа

<DECISION> Оплата прошла?
   ├─ ДА → Шаг 9
   └─ НЕТ → [SYSTEM] "Оплата не прошла. Попробуйте другой способ." → возврат к Шагу 7

>> Шаг 9: [SYSTEM] Подтверждение записи
   - Push-уведомление пользователю: "Запись подтверждена! [Психолог], [дата], [время]"
   - Уведомление психологу: "Новая запись: [дата], [время]"
   - Напоминание за 1 час до консультации (Telegram Bot)

>> Шаг 10: <WAIT> Ожидание времени консультации

>> Шаг 11: [USER] + [PSYCHOLOGIST] Проведение консультации
   - Видео-консультация через встроенный видео-чат или Telegram Video Call
   - Длительность: 50 мин (стандарт)

>> Шаг 12: [SYSTEM] После консультации (через 1 час)
   - Push пользователю: "Как прошла консультация? Оставьте отзыв."
   - Форма: оценка (1-5) + текстовый отзыв

>> Шаг 13: [USER] Оставляет отзыв (опционально)

>> Шаг 14: [SYSTEM] Модерация и публикация отзыва
   - Автоматическая модерация (фильтр нецензурной лексики)
   - При жалобах — ручная модерация

>> Шаг 15: [SYSTEM] Начисление оплаты психологу
   - Сумма за вычетом комиссии платформы (15%)
   - Период выплат: еженедельно

[END] Консультация проведена, отзыв опубликован
```

#### Альтернативные потоки

| ID | Условие | Поток |
|----|---------|-------|
| BP-008-A1 | Отмена записи > 24 часа до сессии | Полный возврат средств на карту |
| BP-008-A2 | Отмена записи < 24 часа | "Отмена менее чем за 24 часа невозможна. Свяжитесь с поддержкой." |
| BP-008-A3 | Психолог отменяет сессию | Автоматический возврат средств + предложение альтернативного слота |
| BP-008-A4 | Пользователь не явился (no-show) | Средства не возвращаются, слот освобождается |

#### Постусловия (Postconditions)

- Консультация проведена и оплачена
- Отзыв опубликован (если оставлен)
- Рейтинг психолога обновлён
- Комиссия платформы зафиксирована
- Аудит-лог: запись, оплата, консультация, отзыв

---

### BP-009: Терапевтический мост ИИ-Психолог

**Связь с FR:** FR-015 (Терапевтический мост)
**Связь с US:** US-040, US-041

#### Участники (Actors)

| Актор | Роль в процессе |
|-------|-----------------|
| Пользователь (A1) | Подтверждает отправку саммари (opt-in) |
| ИИ-система (A5) | Генерирует структурированное саммари |
| Психолог (A3) | Получает и использует саммари, оставляет обратную связь |

#### Предусловия (Preconditions)

- Пользователь на тарифе Standard или Premium
- Пользователь записан к психологу через маркетплейс (BP-008)
- Пользователь имеет историю чата / дневника / упражнений

#### Основной поток

```
[START] Запись к психологу подтверждена (BP-008, Шаг 9)

>> Шаг 1: [SYSTEM] Предложение: "Хотите отправить ИИ-саммари вашему психологу?"
   - Описание: "Саммари поможет психологу понять ваш контекст до сессии"

<DECISION> Пользователь согласен (opt-in)?
   ├─ ДА → Шаг 2
   └─ НЕТ → [END] Психолог проводит сессию без предварительного контекста

>> Шаг 2: [SYSTEM] ИИ генерирует структурированное саммари
   Содержание:
   - Основные темы из последних чат-сессий (за 2 недели)
   - Эмоциональные тренды из дневника (графики)
   - Выполненные КПТ-упражнения и их результаты
   - Выявленные паттерны и триггеры
   - Рекомендации ИИ (что работает, что нет)
   - Данные wearables (если подключены)

>> Шаг 3: [SYSTEM] Показ саммари пользователю для ревью
   - Пользователь может просмотреть весь документ
   - Возможность удалить отдельные блоки ("Не показывать это психологу")

>> Шаг 4: [USER] Подтверждает отправку

>> Шаг 5: [SYSTEM] Отправка саммари психологу
   - Саммари появляется в панели психолога за 24 часа до консультации
   - Уведомление: "Новое саммари от клиента доступно"

>> Шаг 6: [PSYCHOLOGIST] Изучает саммари перед сессией

>> Шаг 7: [PSYCHOLOGIST] Проводит консультацию (BP-008, Шаг 11)

>> Шаг 8: [PSYCHOLOGIST] Оставляет обратную связь после сессии
   - Заметки по сессии (текст)
   - Рекомендации для пользователя
   - Домашнее задание (опционально)

>> Шаг 9: [SYSTEM] Обработка обратной связи
   - Заметки доступны ИИ для персонализации будущих сессий (с согласия пользователя)
   - Рекомендации показываются пользователю в разделе "От моего психолога"
   - Домашнее задание добавляется в план упражнений

[END] Терапевтический мост завершён, контекст передан
```

#### Альтернативные потоки

| ID | Условие | Поток |
|----|---------|-------|
| BP-009-A1 | Недостаточно данных для саммари | "Недостаточно данных для саммари. Ведите дневник и общайтесь с ИИ хотя бы 3 дня." |
| BP-009-A2 | Психолог не открыл саммари до сессии | Уведомление-напоминание за 2 часа до консультации |

#### Постусловия (Postconditions)

- Саммари доставлено психологу
- Обратная связь психолога интегрирована в ИИ-контекст пользователя
- Рекомендации доступны пользователю
- Аудит-лог: генерация саммари, отправка, обратная связь

---

### BP-010: Подписка и оплата

**Связь с FR:** FR-010 (Подписки и платежи)
**Связь с US:** US-028, US-029

#### Участники (Actors)

| Актор | Роль в процессе |
|-------|-----------------|
| Пользователь (A1) | Выбирает тариф, оплачивает |
| Платёжная система (A6) | YooKassa — обработка и рекуррентные платежи |
| Telegram Bot (A8) | Уведомления о списаниях и продлениях |

#### Предусловия (Preconditions)

- Пользователь авторизован
- YooKassa API доступна

#### Основной поток

```
[START] Пользователь выбирает тарифный план (из онбординга BP-001 или из профиля)

>> Шаг 1: [SYSTEM] Отображение тарифов
   - Free: бесплатно (ограничения)
   - Standard: 990 руб/мес (7 дней trial)
   - Premium: 2990 руб/мес (7 дней trial)
   - Сравнительная таблица функций

>> Шаг 2: [USER] Выбирает Standard или Premium

>> Шаг 3: [SYSTEM] Перенаправление на YooKassa
   - Отображение: "7 дней бесплатно, затем [сумма] руб/мес"
   - Способы оплаты: банковская карта, ЮMoney, SBP

>> Шаг 4: [USER] Вводит платёжные данные и подтверждает

>> Шаг 5: [A6 — YooKassa] Привязка карты / обработка
   - Для trial: привязка карты (без списания)
   - Для обычной оплаты: списание суммы

<DECISION> Платёж/привязка успешны?
   ├─ ДА → Шаг 6
   └─ НЕТ → [SYSTEM] "Оплата не прошла. Попробуйте другой способ." → возврат к Шагу 3

>> Шаг 6: [SYSTEM] Активация подписки
   - Мгновенная активация тарифа
   - Push: "Подписка [план] активирована!"
   - Чек отправляется в Telegram (или на email)

>> Шаг 7: [SYSTEM] Планирование рекуррентных платежей
   - Для trial: первое списание через 7 дней
   - Для обычной подписки: ежемесячное списание

>> Шаг 8: <WAIT> За 3 дня до списания

>> Шаг 9: [A8 — Telegram Bot] Уведомление
   - "Через 3 дня будет списано [сумма] за подписку [план]. Управлять подпиской."

>> Шаг 10: <WAIT> День списания

>> Шаг 11: [A6 — YooKassa] Автоматическое списание

<DECISION> Списание успешно?
   ├─ ДА → [SYSTEM] Подписка продлена, push-подтверждение → возврат к Шагу 8
   └─ НЕТ → Шаг 12

>> Шаг 12: [SYSTEM] Grace period (3 дня)
   - Push: "Подписка не продлилась. Обновите способ оплаты."
   - 3 попытки списания в течение grace period

<DECISION> Оплата прошла в grace period?
   ├─ ДА → Подписка продлена → возврат к Шагу 8
   └─ НЕТ → Шаг 13

>> Шаг 13: [SYSTEM] Graceful downgrade
   - Переход на Free-тариф
   - Push: "Подписка завершена. Вы перешли на Free-план."
   - Все данные сохраняются (не удаляются)
   - Доступ к платным функциям ограничивается

[END] Подписка активна / продлена / понижена
```

#### Альтернативные потоки

| ID | Условие | Поток |
|----|---------|-------|
| BP-010-A1 | Пользователь отменяет подписку | Подписка действует до конца оплаченного периода, затем downgrade на Free |
| BP-010-A2 | Смена тарифа Standard → Premium | Пересчёт с учётом оставшихся дней, доплата |
| BP-010-A3 | Промокод (P1) | Ввод промокода → валидация → применение скидки → оплата с учётом скидки |
| BP-010-A4 | Реферальный бонус (BP-012) | Добавление 7 дней Premium к текущей подписке |

#### Постусловия (Postconditions)

- Подписка активирована / продлена / понижена
- Чек отправлен пользователю
- Рекуррентный платёж запланирован
- Аудит-лог: тариф, сумма, статус платежа

---

### BP-011: B2B онбординг

**Связь с FR:** FR-011 (B2B корпоративное управление)
**Связь с US:** US-030, US-031

#### Участники (Actors)

| Актор | Роль в процессе |
|-------|-----------------|
| HR-администратор (A2) | Инициирует, управляет корпоративной группой |
| Администратор платформы (A4) | Обрабатывает заявку, настраивает контракт |
| Сотрудники | Присоединяются к группе через ссылку |

#### Предусловия (Preconditions)

- HR-администратор является пользователем Telegram
- Компания готова к пилотному запуску

#### Основной поток

```
[START] HR-администратор узнаёт о платформе (маркетинг / сайт / рекомендация)

>> Шаг 1: [HR-ADMIN] Заполняет заявку на B2B
   - Компания, должность, кол-во сотрудников, контактные данные
   - Через сайт или Telegram-бот

>> Шаг 2: [ADMIN] Обработка заявки (< 24 часа)
   - Связь с HR-администратором (Telegram / email / звонок)
   - Презентация решения, ответы на вопросы

>> Шаг 3: [ADMIN] Организация демо-сессии
   - 30-минутная онлайн-демонстрация платформы
   - Показ HR-панели, аналитики, процессов

<DECISION> HR-администратор заинтересован?
   ├─ ДА → Шаг 4
   └─ НЕТ → [END] Фиксация причины отказа в CRM

>> Шаг 4: [ADMIN] + [HR-ADMIN] Согласование пилота
   - Период: 1 месяц бесплатно
   - Количество сотрудников для пилота (10-50)
   - KPI пилота: % активных, CSAT, NPS

>> Шаг 5: [ADMIN] Создание корпоративной группы
   - Настройка тарифа B2B (1500 руб/сотр/мес)
   - Генерация ссылки-приглашения для Telegram

>> Шаг 6: [HR-ADMIN] Распространяет ссылку среди сотрудников
   - Рассылка в корпоративном мессенджере / email
   - Информационная презентация для сотрудников

>> Шаг 7: Сотрудники переходят по ссылке
   - Автоматическое добавление в корпоративную группу
   - Онбординг по стандартному процессу (BP-001)
   - Тариф: определяется B2B-контрактом (обычно уровень Premium)

>> Шаг 8: <WAIT> Окончание пилота (1 месяц)

>> Шаг 9: [ADMIN] Подготовка отчёта по пилоту
   - Агрегированная аналитика (анонимизированная)
   - % активных, средний стресс, кол-во сессий
   - Сравнение с отраслевыми бенчмарками

>> Шаг 10: [ADMIN] + [HR-ADMIN] Обсуждение результатов

<DECISION> Компания переходит на полный контракт?
   ├─ ДА → Шаг 11
   └─ НЕТ → [END] Фиксация причины, follow-up через 3 мес.

>> Шаг 11: [ADMIN] Оформление контракта
   - Договор, NDA, SLA
   - Оплата по invoice (ежемесячно или ежеквартально)
   - Настройка лимитов группы

>> Шаг 12: [HR-ADMIN] Управление группой (постоянно)
   - Добавление / удаление сотрудников
   - Просмотр агрегированной аналитики (минимум 10 участников для анонимности)
   - Ежемесячный PDF-отчёт (P1)

[END] B2B-клиент подключён и активен
```

#### Альтернативные потоки

| ID | Условие | Поток |
|----|---------|-------|
| BP-011-A1 | Менее 10 сотрудников в группе | Аналитика недоступна (порог анонимности) |
| BP-011-A2 | Сотрудник покидает компанию | HR удаляет из группы → сотрудник переходит на личный тариф (Free) |

#### Постусловия (Postconditions)

- Корпоративная группа создана и активна
- Сотрудники имеют доступ к платформе по B2B-тарифу
- HR-администратор видит агрегированную аналитику
- Аудит-лог: B2B-онбординг, добавление/удаление сотрудников

---

### BP-012: Реферальная программа

**Связь с FR:** FR-017 (Реферальная программа)
**Связь с US:** US-044

#### Участники (Actors)

| Актор | Роль в процессе |
|-------|-----------------|
| Приглашающий пользователь (A1) | Генерирует и распространяет реферальную ссылку |
| Приглашённый пользователь (A1) | Регистрируется по ссылке |
| Telegram Bot (A8) | Уведомления о бонусах |

#### Предусловия (Preconditions)

- Приглашающий пользователь авторизован в системе
- Лимит бонусов за месяц не исчерпан (10 бонусов/мес)

#### Основной поток

```
[START] Пользователь нажимает "Пригласить друга" (Профиль / Главная)

>> Шаг 1: [SYSTEM] Генерация реферальной ссылки
   - Уникальный Telegram deep link
   - QR-код
   - Кнопка "Поделиться в Telegram" (native share)

>> Шаг 2: [USER — Приглашающий] Отправляет ссылку другу
   - Через Telegram, мессенджеры, соцсети

>> Шаг 3: <WAIT> Друг переходит по ссылке

>> Шаг 4: [USER — Приглашённый] Регистрируется (BP-001)
   - Система автоматически связывает приглашённого с приглашающим

>> Шаг 5: [SYSTEM] Проверка условий бонуса

<DECISION> Все условия выполнены?
   ├─ Приглашённый — новый пользователь ✓
   ├─ Приглашающий не достиг лимита (10/мес) ✓
   │  → Шаг 6
   ├─ Приглашающий достиг лимита →
   │  [SYSTEM] Приглашённый получает бонус, приглашающий — уведомление о лимите
   └─ Приглашённый уже зарегистрирован → [END] Без бонуса

>> Шаг 6: [SYSTEM] Начисление бонусов
   - Приглашённый: 7 дней Premium trial (вместо Standard)
   - Приглашающий: +7 дней Premium (добавляются к текущей подписке)

>> Шаг 7: [A8 — Telegram Bot] Уведомления
   - Приглашающему: "Ваш друг зарегистрировался! Вам начислено 7 дней Premium."
   - Приглашённому: "Добро пожаловать! Вы получили 7 дней Premium от [Имя]."

>> Шаг 8: [SYSTEM] Обновление статистики рефералов
   - Кол-во приглашённых, кол-во активированных, статус бонусов

[END] Бонусы начислены обоим участникам
```

#### Альтернативные потоки

| ID | Условие | Поток |
|----|---------|-------|
| BP-012-A1 | Лимит 10 бонусов/мес исчерпан | Приглашающий: "Лимит бонусов на этот месяц достигнут. Новые бонусы с [дата]." |
| BP-012-A2 | Попытка фрода (множественные аккаунты) | Система анти-фрода блокирует начисление бонуса |

#### Постусловия (Postconditions)

- Реферальная связь зафиксирована
- Бонусы начислены (при выполнении условий)
- Статистика рефералов обновлена
- Аудит-лог: реферал, бонусы

---

### BP-013: Мини-курс

**Связь с FR:** FR-016 (Мини-курсы самообразования)
**Связь с US:** US-042, US-043

#### Участники (Actors)

| Актор | Роль в процессе |
|-------|-----------------|
| Пользователь (A1) | Выбирает и проходит курс |
| ИИ-система (A5) | Рекомендация курса, проверка тестов |

#### Предусловия (Preconditions)

- Пользователь авторизован
- Контент курсов загружен в систему
- Лимит по тарифу: Free — 1 курс, Standard/Premium — все

#### Основной поток

```
[START] Пользователь нажимает "Обучение" / "Мини-курсы"

>> Шаг 1: [SYSTEM] Отображение каталога курсов
   - Категории: тревога, стресс, сон, отношения, самооценка, EQ
   - Для каждого: название, описание, кол-во уроков, длительность, иконка
   - ИИ-рекомендация: "Рекомендуем для вас" (на основе профиля и дневника)

>> Шаг 2: [USER] Выбирает курс

<DECISION> Курс доступен по тарифу?
   ├─ ДА → Шаг 3
   └─ НЕТ (Free, курс платный) → "Доступно на Standard/Premium" + предложение апгрейда → [END]

>> Шаг 3: [SYSTEM] Отображение оглавления курса
   - Список уроков (5-7 шт.)
   - Прогресс: пройдено X из Y
   - Следующий урок выделен

>> Шаг 4: [USER] Выбирает урок (или продолжает с последнего)

>> Шаг 5: [SYSTEM] Теоретический блок
   - Текст + иллюстрации (3-5 мин чтения)
   - Ключевые концепции выделены

>> Шаг 6: [USER] Изучает материал

>> Шаг 7: [SYSTEM] Мини-тест (2-3 вопроса)
   - Вопросы на закрепление материала
   - Формат: множественный выбор или true/false

>> Шаг 8: [USER] Отвечает на вопросы

<DECISION> Тест пройден? (>= 2 из 3 правильных)
   ├─ ДА → Шаг 9
   └─ НЕТ → [SYSTEM] "Попробуйте ещё раз" + подсветка правильных ответов → возврат к Шагу 7

>> Шаг 9: [SYSTEM] Практика (мини-упражнение)
   - Связанное с темой урока упражнение (аналогично BP-005, но короче)
   - Время: 3-5 мин

>> Шаг 10: [USER] Выполняет практику

>> Шаг 11: [SYSTEM] Завершение урока
   - "Урок пройден!" + мотивационное сообщение
   - Обновление прогресса курса (% завершения)
   - Серия дней (если урок каждый день)

<DECISION> Курс полностью пройден?
   ├─ ДА → [SYSTEM] Сертификат о прохождении (P2) + достижение в геймификации
   └─ НЕТ → [END] Прогресс сохранён

[END] Урок/курс пройден, прогресс обновлён
```

#### Альтернативные потоки

| ID | Условие | Поток |
|----|---------|-------|
| BP-013-A1 | Пользователь прерывает урок | Прогресс сохраняется, при возврате — продолжение с места остановки |
| BP-013-A2 | ИИ рекомендует курс из чата | Прямая ссылка на рекомендованный курс |

#### Постусловия (Postconditions)

- Прогресс курса обновлён
- При завершении курса — сертификат (P2)
- Геймификация: достижение "Исследователь" (первый курс)
- Аудит-лог: урок, курс, тест, прогресс

---

### BP-014: Геймификация

**Связь с FR:** FR-018 (Терапевтическая геймификация)
**Связь с US:** US-045, US-046, US-047

#### Участники (Actors)

| Актор | Роль в процессе |
|-------|-----------------|
| Пользователь (A1) | Совершает терапевтические действия |
| ИИ-система (A5) | Начисляет прогресс, генерирует отчёты |

#### Предусловия (Preconditions)

- Пользователь авторизован
- Виджет "Дерево здоровья" активен на главном экране

#### Основной поток

```
[START] Пользователь совершает терапевтическое действие

>> Шаг 1: [SYSTEM] Определение типа действия и начисление прогресса
   - Запись в дневник → +1 лист на дереве
   - КПТ-упражнение → +1 лист на дереве
   - Медитация → +1 цветок на дереве
   - Чат-сессия → рост ствола
   - SOS-протокол → укрепление корней

>> Шаг 2: [SYSTEM] Обновление визуала "Дерево здоровья"
   - Анимация роста (плавное появление нового элемента)
   - Дерево эволюционирует: росток → маленькое дерево → среднее → большое → цветущее

>> Шаг 3: [SYSTEM] Проверка достижений

<DECISION> Условие достижения выполнено?
   ├─ ДА → Шаг 4
   └─ НЕТ → Шаг 5

>> Шаг 4: [SYSTEM] Уведомление о достижении
   - Push: "Достижение открыто: [название]!"
   - Примеры:
     - "7 дней осознанности" (7 записей подряд)
     - "Первая победа над тревогой" (улучшение после SOS)
     - "Мастер дыхания" (10 дыхательных практик)
     - "Исследователь" (первый мини-курс)
     - "Мост к здоровью" (первая консультация через маркетплейс)

>> Шаг 5: [SYSTEM] Обновление серий (streaks)
   - Дневник: N дней подряд
   - Упражнения: N дней подряд
   - Медитации: N дней подряд
   - При достижении 7/14/30 дней → бонусное достижение

<DECISION> Пользователь пропустил день?
   ├─ ДА → [SYSTEM] Мягкий сброс серии: "Пауза — это тоже забота о себе. Готовы продолжить?"
   │        Рекорд сохраняется: "Ваш рекорд: N дней"
   └─ НЕТ → Серия продолжается

>> Шаг 6: [SYSTEM] Еженедельный отчёт прогресса (каждое воскресенье)
   - Визуализация роста дерева за неделю
   - Статистика: сессии, упражнения, медитации, дневник
   - Сравнение с предыдущей неделей
   - Мотивационное сообщение от ИИ

[END] Прогресс обновлён, достижения начислены
```

#### Альтернативные потоки

| ID | Условие | Поток |
|----|---------|-------|
| BP-014-A1 | Пользователь хочет поделиться достижением | Кнопка "Поделиться в Telegram" (P2) — без раскрытия деталей терапии |
| BP-014-A2 | Длительный перерыв (> 7 дней) | Дерево показывает "листопад" (визуально), но НЕТ наказания; мягкое приветствие при возврате |

#### Постусловия (Postconditions)

- Визуал дерева обновлён
- Достижения начислены (если условия выполнены)
- Серии обновлены
- Еженедельный отчёт доставлен (по расписанию)
- Аудит-лог: действие, прогресс, достижения

---

## 4. Gap Analysis

| # | AS-IS проблема | TO-BE решение | FR | Ожидаемый эффект |
|---|---------------|---------------|-----|-----------------|
| G1 | Финансовый барьер (3000-7000 руб/сессия) | Freemium 0/990/2990 руб/мес с неограниченными сессиями | FR-002, FR-010 | Снижение стоимости на 80-95% |
| G2 | Временной барьер (запись за 3-14 дней) | Мгновенный доступ 24/7 через Telegram | FR-002, FR-003 | Время до помощи: < 30 сек |
| G3 | Географический барьер (нет специалистов в регионе) | Доступ из любой точки через интернет | FR-002, FR-007 | 100% географический охват |
| G4 | Стигматизация (60% не обращаются) | Анонимный чат в привычном Telegram | FR-002, FR-001 | Снижение барьера обращения |
| G5 | Нет помощи в момент кризиса (ночь, выходные) | SOS-протоколы + ИИ-чат 24/7 | FR-014, FR-002, FR-006 | Помощь доступна в любое время |
| G6 | Нет преемственности между сессиями | Терапевтический мост: ИИ-саммари для психолога | FR-015 | Экономия 10-15 мин на каждой сессии |
| G7 | Нет самопомощи между визитами | КПТ-упражнения + дневник + медитации | FR-005, FR-004, FR-008 | Непрерывная терапевтическая поддержка |
| G8 | Высокий порог входа (не знают с чего начать) | Онбординг-опросник + ИИ-персонализация | FR-001, FR-002 | Мгновенные рекомендации |
| G9 | Корп. wellness: низкая вовлечённость EAP (3-8%) | Привычный Telegram, анонимность, персонализация | FR-011 | Целевая вовлечённость > 30% |
| G10 | Корп. wellness: нет аналитики для HR | Агрегированная анонимная аналитика | FR-011 | Измеримый ROI wellness-программы |
| G11 | Нет мотивации к регулярной практике | Геймификация + серии + дерево здоровья | FR-018 | Retention +50% |
| G12 | Виральный рост отсутствует | Реферальная программа через Telegram | FR-017 | Органический рост 15-20% |
| G13 | Пользователь не понимает свои паттерны | ИИ-анализ дневника: триггеры, циклы, корреляции | FR-004 | Осознание паттернов за 1-2 недели |
| G14 | Нет обучения по психологическому здоровью | Мини-курсы: КПТ, стресс, сон, EQ | FR-016 | Повышение психологической грамотности |

---

## 5. Automation Opportunities

### 5.1 Полностью автоматизированные процессы

| Процесс | Описание | Технология |
|---------|----------|-----------|
| Telegram OAuth регистрация | Создание аккаунта без ручного ввода | Telegram WebApp SDK |
| ИИ-чат сессия | Весь цикл диалога | GigaChat/YandexGPT + LangChain |
| Голосовая сессия (STT/TTS) | Распознавание и синтез речи | Self-hosted STT/TTS |
| Детектор кризисов | Анализ каждого сообщения | LLM + кризисные маркеры |
| SOS-протоколы | Пошаговый протокол без участия оператора | Предзаписанные протоколы + TTS |
| Дневник — ИИ-анализ паттернов | Выявление триггеров и циклов | LLM analytics |
| Push-напоминания | Отправка по расписанию с проверкой условий | APScheduler + Telegram Bot |
| Рекуррентные платежи | Автоматическое списание и продление | YooKassa API |
| Graceful degradation | Автоматический fallback при лимитах | Система лимитов (FR-013) |
| Геймификация | Начисление прогресса и достижений | Event-driven система |
| Реферальная привязка | Связь реферала и бонусы | Telegram deep links |
| Синхронизация wearables | Периодическая подгрузка биометрии | HealthKit / Mi Fit API |

### 5.2 Частично автоматизированные (ИИ + ручная работа)

| Процесс | Автоматизировано | Ручная работа |
|---------|-----------------|---------------|
| Терапевтический мост | Генерация саммари (ИИ) | Обратная связь психолога |
| Маркетплейс — верификация | Автомодерация отзывов | Верификация дипломов, ручная модерация жалоб |
| Мини-курсы | Проверка тестов, прогресс | Создание контента (психологи-авторы) |
| B2B-аналитика | Агрегация, анонимизация | Интерпретация для HR, PDF-отчёт |
| Детектор кризисов — critical | Автоматическая классификация | Реакция дежурного оператора |

### 5.3 Ручные процессы

| Процесс | Описание | Ответственный |
|---------|----------|---------------|
| B2B продажи | Демо, переговоры, контракт | Администратор / Sales |
| Верификация психологов | Проверка дипломов, сертификатов | Администратор |
| Аудит детектора кризисов | Ежемесячный пересмотр маркеров | Клинический консультант |
| Создание контента курсов | Написание уроков, тестов | Психолог-автор |
| Инцидент-менеджмент | Реакция на critical-алерты | Дежурный оператор |
| Настройка лимитов | Корректировка бюджетов и порогов | Администратор |

---

## 6. Метрики процессов (KPI)

| Процесс | Метрика | Целевое значение | Как измерять |
|---------|---------|------------------|--------------|
| **BP-001: Онбординг** | Conversion: открыл бот → регистрация | > 60% | Analytics: воронка онбординга |
| | Conversion: регистрация → заполнение опросника | > 70% | Analytics: шаги опросника |
| | Время онбординга (до главного экрана) | < 3 мин | Timestamp start → end |
| **BP-002: AI-чат** | Среднее кол-во сообщений за сессию | > 8 | Метрика чат-сессий |
| | CSAT (оценка сессии) | > 4.2/5 | Рейтинг после сессии |
| | Время ответа ИИ (первый токен) | < 2 сек | NFR-001 |
| | Сессий/неделю на пользователя | > 3 | Tracking plan |
| **BP-003: Голосовая сессия** | STT accuracy (точность распознавания) | > 90% | A/B тестирование |
| | TTS latency | < 2 сек | Prometheus |
| | % переключений голос → текст (из-за проблем) | < 10% | Event tracking |
| **BP-004: Дневник** | DAU дневника / MAU | > 40% | Analytics |
| | Средняя регулярность (записей/неделю) | > 4 | Tracking plan |
| | Время до первого инсайта ИИ | < 7 дней | От первой записи до инсайта |
| **BP-005: КПТ-упражнения** | Completion rate (начал → завершил) | > 75% | Event tracking |
| | Среднее улучшение интенсивности до/после | > 2 пункта | Разница оценок |
| | Упражнений/неделю на пользователя | > 2 | Tracking plan |
| **BP-006: Детектор кризисов** | Accuracy (правильная классификация) | > 95% | Аудит + метки |
| | False negative rate | < 1% | Клинический аудит |
| | Время реакции (critical → отображение) | < 1 сек | System monitoring |
| **BP-007: SOS-протокол** | Среднее улучшение оценки (до vs после) | > 3 пункта | Оценки до/после |
| | Completion rate (начал → завершил) | > 80% | Event tracking |
| | Время от нажатия SOS до начала протокола | < 5 сек | Timestamp |
| **BP-008: Маркетплейс** | Conversion: просмотр каталога → запись | > 5% | Воронка маркетплейса |
| | No-show rate | < 15% | Статистика консультаций |
| | Средний рейтинг психологов | > 4.5/5 | Рейтинговая система |
| | Повторных записей (re-booking rate) | > 30% | Tracking plan |
| **BP-009: Терап. мост** | Opt-in rate (согласие на саммари) | > 50% | Event tracking |
| | CSAT психолога (полезность саммари) | > 4.0/5 | Обратная связь психолога |
| **BP-010: Подписка** | Conversion Free → Paid | > 5% | Analytics |
| | Churn rate (ежемесячный) | < 8% | Billing analytics |
| | Trial → Paid conversion | > 30% | Analytics |
| | ARPU | > 800 руб | Revenue / MAU |
| **BP-011: B2B** | Время от заявки до пилота | < 2 недели | CRM |
| | Conversion пилот → контракт | > 50% | CRM |
| | Вовлечённость сотрудников | > 30% | HR-аналитика |
| **BP-012: Реферальная** | Viral coefficient (k-factor) | > 0.3 | Рефералы / пользователи |
| | Conversion ссылка → регистрация | > 20% | Deep link analytics |
| **BP-013: Мини-курсы** | Completion rate (курс целиком) | > 40% | Прогресс курсов |
| | Средний тест score | > 80% | Результаты тестов |
| **BP-014: Геймификация** | DAU с геймификацией / общий DAU | > 60% | Analytics |
| | Средняя длина серии (streak) | > 5 дней | Streak analytics |
| | Retention D30 (с геймификацией vs без) | +50% | A/B тестирование |

---

## 7. Swimlane Summary

### Матрица: Процесс x Актор

| Процесс | Пользователь (A1) | HR-Admin (A2) | Психолог (A3) | Админ (A4) | ИИ-система (A5) | YooKassa (A6) | Wearable (A7) | Telegram Bot (A8) |
|---------|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
| BP-001: Онбординг | **I,E** | | | | A | | | I |
| BP-002: AI-чат | **I,E** | | | | **P** | | | |
| BP-003: Голосовая сессия | **I,E** | | | | **P** | | | |
| BP-004: Дневник эмоций | **I,E** | | | | A | | C | N |
| BP-005: КПТ-упражнение | **I,E** | | | | R,A | | | |
| BP-006: Детектор кризисов | | | | N | **P** | | | N |
| BP-007: SOS-протокол | **I,E** | | | | **P** | | | |
| BP-008: Маркетплейс | **I,E** | | **P,E** | M | R | **P** | | N |
| BP-009: Терап. мост | C | | **E** | | **P** | | | |
| BP-010: Подписка | **I** | | | | | **P** | | N |
| BP-011: B2B онбординг | E | **I** | | **P** | | | | N |
| BP-012: Реферальная | **I** | | | | V | | | N |
| BP-013: Мини-курс | **I,E** | | | | R,V | | | |
| BP-014: Геймификация | | | | | **P** | | | N |

**Легенда:**

| Символ | Значение |
|--------|----------|
| **I** | Инициатор (Initiator) — запускает процесс |
| **E** | Исполнитель (Executor) — выполняет основные действия |
| **P** | Процессор (Processor) — обрабатывает данные / выполняет ключевую логику |
| A | Аналитик (Analyzer) — анализирует данные |
| R | Рекомендатель (Recommender) — формирует рекомендации |
| V | Валидатор (Validator) — проверяет условия |
| C | Контрибьютор (Contributor) — предоставляет данные |
| N | Нотификатор (Notifier) — отправляет уведомления |
| M | Модератор (Moderator) — модерирует контент |

### Ключевые наблюдения

1. **ИИ-система (A5)** участвует в 13 из 14 процессов — является ядром платформы.
2. **Пользователь (A1)** является инициатором 11 из 14 процессов — user-centric дизайн.
3. **Telegram Bot (A8)** задействован как нотификатор в 8 процессах — единая точка коммуникации.
4. **YooKassa (A6)** участвует только в 2 процессах, но они критичны для монетизации.
5. **Администратор (A4)** вовлечён минимально — система максимально автоматизирована.

---

*Документ создан: Business-Analyst Agent | Дата: 2026-02-04*
